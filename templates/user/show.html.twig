{% extends 'base.html.twig' %}

{% block title %}User{% endblock %}

{% block body %}

	{% for message in app.flashes('note') %}
            <div class="alert alert-danger">
                {{ message }}
            </div>
    {% endfor %}

    <div class="accordion" id="accordionExample">
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingOne">
            <button
                class="accordion-button"
                type="button"
                data-mdb-toggle="collapse"
                data-mdb-target="#collapseOne"
                aria-expanded="true"
                aria-controls="collapseOne"
            >
                <h1 style="color: black">User</h1>
            </button>
            </h2>
            <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-mdb-parent="#accordionExample">
            <div class="accordion-body">
                 <table class="table">
        <tbody>
            <tr>
                <th>Id</th>
                <td>{{ user.id }}</td>
            </tr>
            <tr>
                <th>Name</th>
                <td>{{ user.name }}</td>
            </tr>
            <tr>
                <th>Email</th>
                <td>{{ user.email }}</td>
            </tr>
            <tr>
                <th>Gender</th>
                <td>{{ user.gender ? 'Male' : 'Female' }}</td>
            </tr>
            <tr>
                <th>Birthdate</th>
                <td>{{ user.birthdate ? user.birthdate|date('Y-m-d') : '' }}</td>
            </tr>
        </tbody>
    </table>
            </div>
            </div>
        </div>
    </div>

   
   <h3>Equipment</h3>
   	<div class="d-flex">	
		<div style="width: 400px" class="me-2">
			<form class="d-none d-md-flex input-group w-auto my-auto" action="#">
				<input autocomplete="off" type="search" class="form-control rounded" placeholder='Search ...' style="min-width: 250px" name="id" id="searchtable" />
				<button type="submit" class="btn btn-dark searchSubmitBtn">
					<i class="fas fa-search"></i>
				</button>
			</form>
		</div>

		<div class="dropdown">
			<button
				class="btn btn-dark dropdown-toggle"
				type="button"
				id="dropdownMenuButton"
				data-mdb-toggle="dropdown"
				aria-expanded="false"
			>
				Filter
			</button>
			<ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
				{% for category in categories %}
					<li>
						<a class="dropdown-item categoryFilter" href="#" data-id={{category.id}}>{{category.name}}</a>
					</li>
				{% endfor %}
			</ul>
		</div>
	</div>
    {% if equipments %}
	<table class="table">
		 <thead class="table-dark">
			<tr>
				<th>Id</th>
				<th>Serial_number</th>
				<th>Name</th>
				<th>Description</th>
				<th>Status</th>
				<th>Category</th>
				<th>Date assign</th>
				<th>Due date</th>
			</tr>
		</thead>
          
	    <tbody>
                {% for equipment in equipments %}
                <tr>
                    <td>{{ equipment.id }}</td>
					<td>{{ equipment.serialNumber }}</td>
					<td>{{ equipment.name }}</td>
					<td>{{ equipment.description }}</td>
					<td>{{ equipment.status }}</td>
					<td>{{ equipment.category.name }}</td>
	                <td>
						{{ equipment.getLastAssign() ? equipment.getLastAssign().getDateAssign()|date('d-m-Y'): "" }}
					</td>
					<td>
						{{ equipment.getLastAssign() ? equipment.getLastAssign().getDueDate()|date('d-m-Y'): "" }}
					</td>
                </tr>
                {% endfor %}
		</tbody>
	</table>
    {% else %}
        <h4>Not found equipment</h4>
    {% endif %}
	 {% if app.user %}
	{% if 'ROLE_ADMIN' in app.user.roles %}
    <a href="{{ path('app_user_index') }}" class="btn btn-dark mt-2 px-0" style="width: 130px">back to list</a>
<br>
    <a href="{{ path('app_user_edit', {'id': user.id}) }}" class="btn btn-dark mt-2 " style="width: 130px">edit</a>

    {{ include('user/_delete_form.html.twig') }}
    {% endif %}
	{% endif %}
{% endblock %}

{% block scripts %}

<script>
	
		window.addEventListener('DOMContentLoaded', (event) => {
    
	// ajax rate-limit request
			function throttle(func, wait) {
				var timeout;
				return function() {
					var context = this, args = arguments;
					if (!timeout) {
						timeout = setTimeout(function() {
							timeout = null;
							func.apply(context, args);
						}, wait);
					}
				}
			}


			// livesearching equipment
			$('.searchSubmitBtn').on('click', function(e) {
				e.preventDefault();
			})
			$('.searchSubmitBtn').on('click', throttle(function() {
				
				let inputSearch = $('#searchtable')
			 	$value = inputSearch.val();
				console.log(inputSearch);
				var token = inputSearch.data('token');
				if ($value) {
					$.ajax({
						type: 'get',
						url: '{{ (path("app_user_search")) }}',
						data: {
							'value': $value
						},
						success: function(data) {
							console.log(data);
							if (data.success && data.success === false) {
								$('tbody').html(data.message);
							}
							else $('tbody').html(data);
							//console.log(data)
						},
					});	
				}
				//console.log($value);
  	  		},500))
		
			/// filter equipment by category
			$('.categoryFilter').click( throttle(function () {
				$id = $(this).data('id');
				console.log($id);
				$.ajax({
					type: 'get',
					url: '{{ (path("app_user_filter")) }}',
					data: {
						'id': $id
					},
					success: function(data) {
						console.log(data.success)
						if (data.success && data.success === false) {
							$('tbody').html(data.message);
						}
						else $('tbody').html(data);
					}
				});	
			},300))
        })
</script>

{% endblock %}
